name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update manifest.json version
        run: |
          sed -i 's/"version": ".*"/"version": "${{ steps.get_version.outputs.VERSION }}"/' custom_components/ai_toolset/manifest.json

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Changes in this Release
            ${{ steps.changelog.outputs.changelog }}
            
            ## Installation
            
            ### HACS (Recommended)
            1. Open HACS in Home Assistant
            2. Go to Integrations
            3. Click the three dots in the top right
            4. Select "Custom repositories"
            5. Add this repository URL
            6. Install "AI Toolset"
            
            ### Manual Installation
            1. Download `ai_toolset.zip` from this release
            2. Extract to `custom_components/ai_toolset/` in your Home Assistant config directory
            3. Restart Home Assistant
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true

  build:
    name: Build and Attach Assets
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create zip archive
        run: |
          cd custom_components
          zip -r ../ai_toolset.zip ai_toolset/
          cd ..

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ai_toolset.zip
